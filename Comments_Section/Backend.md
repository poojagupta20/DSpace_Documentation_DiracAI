# **Bitstream Comment Management System Documentation** 💬

This document details the design, implementation, and API of the Bitstream Comment Management System within a DSpace environment.

---

## **Why?** 🤔

To enable users (specifically administrators initially) to add, manage, and view textual comments associated with individual bitstreams in the DSpace repository, enhancing content context and collaboration capabilities. 🤝

---

## **1. System Architecture Overview** 🏗️

### **Why?**

To establish a clear separation of concerns, improve modularity, maintainability, and testability of the application by dividing its functionality into distinct layers. 🧩

### **1.1. Layers**

* **Controller Layer (Web/API Interface):** Handles incoming HTTP requests, routes them to appropriate services, and formats responses. 🌐
* **Service Layer (Business Logic):** Contains the core application logic, orchestrates operations across repositories, and enforces business rules (e.g., authorization). 🧠
* **Repository Layer (Data Access):** Provides an abstraction over the database, handling CRUD operations for entities. 💾
* **Entity Layer (Data Model):** Represents the structure of data as stored in the database. 📋
* **DTO Layer (Data Transfer Objects):** Defines the structure of data exchanged between layers and with the client, decoupling the API from internal models. ↔️

---

## **2. Code Implementation Details** 💻

This section provides Javadoc-style explanations for each core component. 📝

### **2.1. BitstreamComment (Entity)**

**File:** `org.dspace.content.Diracai.BitstreamComment` 📄

```java
package org.dspace.content.Diracai;

import jakarta.persistence.*;
import java.time.LocalDateTime;
import java.util.UUID;

/**
 * Represents a comment associated with a bitstream in the DSpace system.
 * This entity maps directly to the 'bitstream_comment' table in the database. 📊
 */
@Entity
@Table(name = "bitstream_comment")
public class BitstreamComment {

    /**
     * Unique identifier for the comment.
     * This is the primary key and is auto-generated by the database. 🔑
     */
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private int id;

    /**
     * The actual text content of the comment. Cannot be null. ✍️
     */
    @Column(nullable = false)
    private String text;

    /**
     * The UUID of the bitstream to which this comment belongs. Cannot be null. 🔗
     */
    @Column(name = "bitstream_id", nullable = false)
    private UUID bitstreamId;

    /**
     * The UUID of the DSpace EPerson who made this comment. Cannot be null. 👤
     */
    @Column(name = "commenter_id", nullable = false)
    private UUID commenterId;

    /**
     * The timestamp when the comment was created. Automatically set on creation. Cannot be null. 🕰️
     */
    @Column(name = "comment_date", nullable = false)
    private LocalDateTime commentDate;

    /**
     * A flag indicating if the comment has been soft-deleted. Default is false. Cannot be null. 🗑️
     */
    @Column(name = "is_deleted", nullable = false)
    private boolean isDeleted;

    /**
     * Default constructor required by JPA.
     */
    public BitstreamComment() {}

    /**
     * Custom constructor for convenient creation of new BitstreamComment instances.
     * The 'isDeleted' flag is initialized to false by default.
     *
     * @param text The text content of the comment.
     * @param bitstreamId The UUID of the associated bitstream.
     * @param commenterId The UUID of the EPerson who created the comment.
     */
    public BitstreamComment(String text, UUID bitstreamId, UUID commenterId) {
        this.text = text;
        this.bitstreamId = bitstreamId;
        this.commenterId = commenterId;
        this.isDeleted = false; // Default to false
    }

    /**
     * JPA lifecycle callback method executed before the entity is first persisted.
     * Sets the 'commentDate' to the current LocalDateTime. ➕
     */
    @PrePersist
    protected void onCreate() {
        this.commentDate = LocalDateTime.now();
    }

    // Getters and Setters omitted for brevity in documentation example, but present in full code.
}
```

### **2.2. BitstreamCommentRepository (Repository)**

**File:** `org.dspace.app.rest.diracai.Repository.BitstreamCommentRepository` 📄

```java
package org.dspace.app.rest.diracai.Repository;

import org.dspace.content.Diracai.BitstreamComment;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.stereotype.Repository;

import java.util.List;
import java.util.UUID;

/**
 * Spring Data JPA repository for managing {@link BitstreamComment} entities.
 * Provides standard CRUD operations and custom query methods. 🚀
 */
@Repository
public interface BitstreamCommentRepository extends JpaRepository<BitstreamComment, Integer> {

    /**
     * Finds all comments associated with a specific bitstream ID that have not been soft-deleted.
     * Spring Data JPA automatically generates the query based on the method name. ✨
     *
     * @param bitstreamId The UUID of the bitstream.
     * @return A list of non-deleted comments for the given bitstream. 📜
     */
    List<BitstreamComment> findByBitstreamIdAndIsDeletedFalse(UUID bitstreamId);
}
```

### **2.3. BitstreamCommentService (Service Layer Interface)**

**File:** `org.dspace.app.rest.diracai.service.BitstreamCommentService` 📄

```java
package org.dspace.app.rest.diracai.service;

import org.dspace.app.rest.diracai.dto.Request.BitstreamCommentRequest;
import org.dspace.app.rest.diracai.dto.Response.BitstreamCommentResponse;
import org.dspace.core.Context;

import java.util.List;
import java.util.UUID;

/**
 * Interface defining the business logic operations for Bitstream Comments.
 * This promotes loose coupling and allows for different implementations. 🔄
 */
public interface BitstreamCommentService {

    BitstreamCommentResponse create(Context context, BitstreamCommentRequest request);

    BitstreamCommentResponse update(Context context, int id, BitstreamCommentRequest request);

    void delete(int id);

    BitstreamCommentResponse getById(Context context, int id);

    List<BitstreamCommentResponse> getByBitstreamId(Context context, UUID bitstreamId);
}
```

### **2.4. BitstreamCommentServiceImpl (Service Layer Implementation)**

**File:** `org.dspace.app.rest.diracai.service.impl.BitstreamCommentServiceImpl` 📄

```java
package org.dspace.app.rest.diracai.service.impl;

import org.dspace.app.rest.diracai.dto.Request.BitstreamCommentRequest;
import org.dspace.app.rest.diracai.dto.Response.BitstreamCommentResponse;
import org.dspace.app.rest.diracai.Repository.BitstreamCommentRepository;
import org.dspace.app.rest.diracai.service.BitstreamCommentService;
import org.dspace.authorize.service.AuthorizeService;
import org.dspace.content.Diracai.BitstreamComment;
import org.dspace.core.Context;
import org.dspace.eperson.EPerson;
import org.dspace.eperson.service.EPersonService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import java.sql.SQLException;
import java.util.List;
import java.util.UUID;
import java.util.stream.Collectors;

/**
 * Implementation of the {@link BitstreamCommentService} interface.
 * Contains the core business logic for bitstream comment management. 💡
 */
@Service
public class BitstreamCommentServiceImpl implements BitstreamCommentService {

    @Autowired private BitstreamCommentRepository repository;
    @Autowired private AuthorizeService authorizeService;
    @Autowired private EPersonService ePersonService;

    /**
     * Creates a new bitstream comment.
     * Enforces that only DSpace administrators can create comments. 🔒
     * @param context The DSpace context of the current operation.
     * @param request The DTO containing the comment details.
     * @return The response DTO of the newly created comment.
     * @throws RuntimeException if authorization fails or other underlying issues occur.
     */
    @Override
    public BitstreamCommentResponse create(Context context, BitstreamCommentRequest request) {
        EPerson user = context.getCurrentUser();
        try {
            if (!authorizeService.isAdmin(context, user)) {
                throw new RuntimeException("Only admin users are allowed to create comments.");
            }
        } catch (SQLException e) {
            throw new RuntimeException("Authorization check failed", e);
        }
        BitstreamComment comment = new BitstreamComment(
                request.getComment(), request.getBitstreamId(), user.getID());
        BitstreamComment saved = repository.save(comment);
        return mapToResponse(context, saved);
    }

    /**
     * Updates an existing bitstream comment identified by its ID. ✏️
     * @param context The DSpace context.
     * @param id The ID of the comment to update.
     * @param request The DTO containing the updated comment details.
     * @return The response DTO of the updated comment.
     * @throws RuntimeException if the comment with the given ID is not found.
     */
    @Override
    public BitstreamCommentResponse update(Context context, int id, BitstreamCommentRequest request) {
        BitstreamComment existing = repository.findById(id)
                .orElseThrow(() -> new RuntimeException("Comment not found with id: " + id));
        existing.setText(request.getComment());
        existing.setBitstreamId(request.getBitstreamId()); // Note: reconsider if bitstreamId should be updatable.
        BitstreamComment saved = repository.save(existing);
        return mapToResponse(context, saved);
    }

    /**
     * Soft-deletes a bitstream comment by setting its 'isDeleted' flag to true. ❌
     * @param id The ID of the comment to delete.
     * @throws RuntimeException if the comment with the given ID is not found.
     */
    @Override
    public void delete(int id) {
        BitstreamComment comment = repository.findById(id)
                .orElseThrow(() -> new RuntimeException("Comment not found with id: " + id));
        comment.setDeleted(true);
        repository.save(comment);
    }

    /**
     * Retrieves a bitstream comment by its unique ID. 🔍
     * @param context The DSpace context.
     * @param id The ID of the comment to retrieve.
     * @return The response DTO of the found comment.
     * @throws RuntimeException if the comment with the given ID is not found.
     */
    @Override
    public BitstreamCommentResponse getById(Context context, int id) {
        BitstreamComment comment = repository.findById(id)
                .orElseThrow(() -> new RuntimeException("Comment not found with id: " + id));
        return mapToResponse(context, comment);
    }

    /**
     * Retrieves a list of all non-deleted comments for a specific bitstream. 📜
     * @param context The DSpace context.
     * @param bitstreamId The UUID of the bitstream.
     * @return A list of response DTOs for the comments associated with the bitstream.
     */
    @Override
    public List<BitstreamCommentResponse> getByBitstreamId(Context context, UUID bitstreamId) {
        return repository.findByBitstreamIdAndIsDeletedFalse(bitstreamId)
                .stream()
                .map(comment -> mapToResponse(context, comment))
                .collect(Collectors.toList());
    }

    /**
     * Private helper method to map a {@link BitstreamComment} entity to a {@link BitstreamCommentResponse} DTO.
     * Fetches the commenter's full name using the EPersonService for display. ➡️
     * @param context The DSpace context.
     * @param comment The BitstreamComment entity to map.
     * @return A BitstreamCommentResponse DTO.
     */
    private BitstreamCommentResponse mapToResponse(Context context, BitstreamComment comment) {
        EPerson user = null;
        String commenterName = "Unknown User";
        try {
            user = ePersonService.find(context, comment.getCommenterId());
        } catch (SQLException e) {
            System.err.println("Error retrieving EPerson for commenter ID: " + comment.getCommenterId() + " - " + e.getMessage());
        }
        if (user != null) {
            commenterName = user.getFullName();
        }
        return new BitstreamCommentResponse(
                comment.getId(), comment.getCommentDate(), comment.getText(), comment.isDeleted(), commenterName);
    }
}
```

### **2.5. BitstreamCommentRequest (DTO - Request)**

**File:** `org.dspace.app.rest.diracai.dto.Request.BitstreamCommentRequest` 📄

```java
package org.dspace.app.rest.diracai.dto.Request;

import java.util.UUID;

/**
 * Data Transfer Object (DTO) for requests related to creating or updating a bitstream comment.
 * Contains the fields expected from the client for comment creation/modification. 📨
 */
public class BitstreamCommentRequest {
    /** The textual content of the comment. */
    private String comment;
    /** The unique identifier (UUID) of the bitstream to which the comment applies. */
    private UUID bitstreamId;

    // Getters and Setters omitted for brevity in documentation example.
}
```

### **2.6. BitstreamCommentResponse (DTO - Response)**

**File:** `org.dspace.app.rest.diracai.dto.Response.BitstreamCommentResponse` 📄

```java
package org.dspace.app.rest.diracai.dto.Response;

import java.time.LocalDateTime;

/**
 * Data Transfer Object (DTO) for responses representing a bitstream comment.
 * This DTO is used to send comment details back to the client,
 * potentially including computed fields like 'commenterName'. ↩️
 */
public class BitstreamCommentResponse {
    /** The unique ID of the comment. */
    private int id;
    /** The textual content of the comment. */
    private String text;
    /** The full name of the EPerson who made the comment. */
    private String commenterName;
    /** The date and time when the comment was created. */
    private LocalDateTime createdDate;
    /** Indicates whether the comment has been soft-deleted. */
    private boolean deleted;

    // Getters and Setters omitted for brevity in documentation example.

    /** Default constructor for the DTO. */
    public BitstreamCommentResponse() {}

    /** Parameterized constructor for convenient creation of response DTOs. */
    public BitstreamCommentResponse(int id, LocalDateTime dateTime, String text, Boolean deleted, String commenterName) {
        this.id = id;
        this.commenterName = commenterName;
        this.text = text;
        this.deleted = deleted;
        this.createdDate = dateTime;
    }

    @Override
    public String toString() {
        return "BitstreamCommentResponse{" +
                "id=" + id +
                ", text='" + text + '\'' +
                ", commenterName='" + commenterName + '\'' +
                ", createdDate=" + createdDate +
                ", deleted=" + deleted +
                '}';
    }
}
```

### **2.7. BitstreamCommentController (Controller)**

**File:** `org.dspace.app.rest.diracai.controller.BitstreamCommentController` 📄

```java
package org.dspace.app.rest.diracai.controller;

import jakarta.servlet.http.HttpServletRequest;
import org.dspace.app.rest.diracai.dto.Request.BitstreamCommentRequest;
import org.dspace.app.rest.diracai.dto.Response.BitstreamCommentResponse;
import org.dspace.app.rest.diracai.service.BitstreamCommentService;
import org.dspace.app.rest.utils.ContextUtil;
import org.dspace.core.Context;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.*;

import java.util.List;
import java.util.UUID;

/**
 * REST Controller for managing bitstream comments.
 * Exposes API endpoints for CRUD operations on comments. 📡
 */
@RestController
@RequestMapping("/api/bitstream/comment")
public class BitstreamCommentController {

    @Autowired private BitstreamCommentService service;

    /**
     * Handles HTTP POST requests to create a new bitstream comment. ➕
     * @param request The request body containing the comment text and bitstream ID.
     * @param httpRequest The HttpServletRequest to obtain the DSpace context.
     * @return A BitstreamCommentResponse DTO representing the newly created comment.
     */
    @PostMapping
    public BitstreamCommentResponse create(@RequestBody BitstreamCommentRequest request, HttpServletRequest httpRequest) {
        Context context = ContextUtil.obtainContext(httpRequest);
        return service.create(context, request);
    }

    /**
     * Handles HTTP PUT requests to update an existing bitstream comment. 🔄
     * @param id The unique ID of the comment to update.
     * @param request The request body containing the updated comment details.
     * @param httpRequest The HttpServletRequest to obtain the DSpace context.
     * @return A BitstreamCommentResponse DTO representing the updated comment.
     */
    @PutMapping("/{id}")
    public BitstreamCommentResponse update(@PathVariable int id, @RequestBody BitstreamCommentRequest request, HttpServletRequest httpRequest) {
        Context context = ContextUtil.obtainContext(httpRequest);
        return service.update(context, id, request);
    }

    /**
     * Handles HTTP DELETE requests to soft-delete a bitstream comment. ➖
     * @param id The unique ID of the comment to delete.
     */
    @DeleteMapping("/{id}")
    public void delete(@PathVariable int id) {
        service.delete(id);
    }

    /**
     * Handles HTTP GET requests to retrieve a single bitstream comment by its ID. 🆔
     * @param id The unique ID of the comment to retrieve.
     * @param httpRequest The HttpServletRequest to obtain the DSpace context.
     * @return A BitstreamCommentResponse DTO representing the found comment.
     */
    @GetMapping("/{id}")
    public BitstreamCommentResponse getById(@PathVariable int id, HttpServletRequest httpRequest) {
        Context context = ContextUtil.obtainContext(httpRequest);
        return service.getById(context, id);
    }

    /**
     * Handles HTTP GET requests to retrieve all non-deleted comments for a specific bitstream. ➡️
     * @param bitstreamId The UUID of the bitstream to retrieve comments for.
     * @param httpRequest The HttpServletRequest to obtain the DSpace context.
     * @return A list of BitstreamCommentResponse DTOs for the specified bitstream.
     */
    @GetMapping("/bitstream/{bitstreamId}")
    public List<BitstreamCommentResponse> getByBitstream(@PathVariable UUID bitstreamId, HttpServletRequest httpRequest) {
        Context context = ContextUtil.obtainContext(httpRequest);
        return service.getByBitstreamId(context, bitstreamId);
    }
}
```

---

## **3. API Endpoint Specification** 🔗

### **Why?**

To provide a clear, standardized contract for how external systems or client applications can interact with the Bitstream Comment Management functionality. 🤝

### **3.1. Base URL**

All endpoints are relative to `/api/bitstream/comment`.

### **3.2. Authentication**

All endpoints require an authenticated DSpace session. Authentication is handled by DSpace's standard REST API mechanisms (e.g., via `/api/authn/login` to obtain an authentication token). 🔑

### **3.3. Endpoints**

#### **3.3.1. Create Comment**

* **Endpoint:** `POST /api/bitstream/comment`
* **Description:** Creates a new comment for a bitstream. 📝
* **Authorization:** Requires DSpace administrator privileges. 👑
* **Request Body (`application/json`):**
    ```json
    {
      "comment": "This is a new comment on the bitstream.",
      "bitstreamId": "a1b2c3d4-e5f6-7890-1234-567890abcdef"
    }
    ```
* **Success Response (`200 OK`):**
    ```json
    {
      "id": 1,
      "text": "This is a new comment on the bitstream.",
      "commenterName": "John Doe",
      "createdDate": "2025-06-13T10:30:00.000",
      "deleted": false
    }
    ```
* **Error Responses:** `401 Unauthorized 🚫`, `403 Forbidden 🛑`, `500 Internal Server Error 💥`.

#### **3.3.2. Update Comment**

* **Endpoint:** `PUT /api/bitstream/comment/{id}`
* **Description:** Modifies an existing comment. 🔄
* **Authorization:** Implied admin access (same as creation, but should be explicit or restricted to original commenter/admin).
* **Path Parameters:**
    * `id` (integer, required): The ID of the comment to update. 🆔
* **Request Body (`application/json`):**
    ```json
    {
      "comment": "This is an updated comment.",
      "bitstreamId": "a1b2c3d4-e5f6-7890-1234-567890abcdef"
    }
    ```
* **Success Response (`200 OK`):**
    ```json
    {
      "id": 1,
      "text": "This is an updated comment.",
      "commenterName": "John Doe",
      "createdDate": "2025-06-13T10:30:00.000",
      "deleted": false
    }
    ```
* **Error Responses:** `404 Not Found 🔍`, `401 Unauthorized 🚫`, `500 Internal Server Error 💥`.

#### **3.3.3. Delete Comment (Soft Delete)**

* **Endpoint:** `DELETE /api/bitstream/comment/{id}`
* **Description:** Marks a comment as deleted (`is_deleted = true`) without removing the record. 🗑️
* **Authorization:** Implied admin access.
* **Path Parameters:**
    * `id` (integer, required): The ID of the comment to delete. 🆔
* **Success Response (`200 OK`):** No content. ✅
* **Error Responses:** `404 Not Found 🔍`, `401 Unauthorized 🚫`, `500 Internal Server Error 💥`.

#### **3.3.4. Get Comment by ID**

* **Endpoint:** `GET /api/bitstream/comment/{id}`
* **Description:** Retrieves the details of a specific bitstream comment by its unique ID. 🔎
* **Authorization:** Requires authenticated DSpace session. 🔑
* **Path Parameters:**
    * `id` (integer, required): The ID of the comment. 🆔
* **Success Response (`200 OK`):**
    ```json
    {
      "id": 1,
      "text": "This is an example comment.",
      "commenterName": "Jane Smith",
      "createdDate": "2025-06-12T15:45:00.000",
      "deleted": false
    }
    ```
* **Error Responses:** `404 Not Found 🔍`, `401 Unauthorized 🚫`, `500 Internal Server Error 💥`.

#### **3.3.5. Get Comments by Bitstream ID**

* **Endpoint:** `GET /api/bitstream/comment/bitstream/{bitstreamId}`
* **Description:** Retrieves a list of all non-deleted comments associated with a specific bitstream. 📋
* **Authorization:** Requires authenticated DSpace session. 🔑
* **Path Parameters:**
    * `bitstreamId` (string, UUID format, required): The UUID of the bitstream. 🔗
* **Success Response (`200 OK`):**
    ```json
    [
      {
        "id": 1,
        "text": "First comment on this bitstream.",
        "commenterName": "John Doe",
        "createdDate": "2025-06-13T10:30:00.000",
        "deleted": false
      },
      {
        "id": 2,
        "text": "Another comment.",
        "commenterName": "Jane Smith",
        "createdDate": "2025-06-13T11:00:00.000",
        "deleted": false
      }
    ]
    ```
    (Returns `[]` if no comments are found or the bitstream has no non-deleted comments.)
* **Error Responses:** `401 Unauthorized 🚫`, `500 Internal Server Error 💥`.

---

## **4. Database Schema** 🗄️

### **Why?**

To define the persistent structure for bitstream comments within the DSpace database. 💾

### **4.1. `bitstream_comment` Table DDL (PostgreSQL Example)**

```sql
CREATE TABLE bitstream_comment (
    id SERIAL PRIMARY KEY,           -- Auto-incrementing integer primary key 🔑
    text TEXT NOT NULL,              -- The text content of the comment ✍️
    bitstream_id UUID NOT NULL,      -- UUID of the associated bitstream 🔗
    commenter_id UUID NOT NULL,      -- UUID of the EPerson who made the comment 👤
    comment_date TIMESTAMP NOT NULL, -- Timestamp of comment creation 🕰️
    is_deleted BOOLEAN NOT NULL      -- Flag for soft deletion, default to FALSE 🗑️
);

-- Recommended indexes for performance ⚡
CREATE INDEX idx_bitstream_comment_bitstream_id ON bitstream_comment (bitstream_id);
CREATE INDEX idx_bitstream_comment_commenter_id ON bitstream_comment (commenter_id);
CREATE INDEX idx_bitstream_comment_is_deleted ON bitstream_comment (is_deleted);

-- Note: Consider adding foreign key constraints if strictly necessary and compatible with DSpace's existing schema patterns.
-- For example:
-- ALTER TABLE bitstream_comment ADD CONSTRAINT fk_bitstream FOREIGN KEY (bitstream_id) REFERENCES bitstream (uuid);
-- ALTER TABLE bitstream_comment ADD CONSTRAINT fk_commenter FOREIGN KEY (commenter_id) REFERENCES eperson (uuid);
```

---

## **5. DSpace Integration Specifics** 🧩

### **Why?**

To highlight how this module interacts with DSpace's core components and adheres to its architectural patterns. 🔄

### **5.1. Key DSpace Components Utilized**

* **`Context` Object:** The `org.dspace.core.Context` is central to DSpace operations, representing the current user session and providing access to DSpace services. It's obtained via `ContextUtil.obtainContext(httpRequest)` in the controller and passed to service methods. 🧑‍💻
* **`AuthorizeService`:** `org.dspace.authorize.service.AuthorizeService` is used for permission checks. Currently, comment creation is restricted to DSpace administrators using `authorizeService.isAdmin(context, user)`. 🛡️
* **`EPersonService`:** `org.dspace.eperson.service.EPersonService` is utilized to retrieve `EPerson` (user) details, specifically to get the `commenterName` for the `BitstreamCommentResponse` DTO. ℹ️

### **5.2. Deployment Considerations**

This module is designed to be deployed as part of the DSpace REST API (Spring Boot) application, typically by including it in a new or existing DSpace module within the `dspace-rest` project. 📦

---



> **Author:** Pooja Gupta 
> **Last Updated:** June 13, 2025  
> **Target DSpace Version:** 8.x+
